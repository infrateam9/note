name: Deploy to AWS Lambda (Optional)

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  GO_VERSION: "1.24"

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests
        run: go test -v -race ./...

  deploy:
    name: Deploy
    needs: test
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    env:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      AWS_OIDC_AUDIENCE: ${{ secrets.AWS_OIDC_AUDIENCE }}

    permissions:
      contents: write
      id-token: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Build binary for Lambda
        run: |
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags="-X main.Version=$(git describe --tags --always) -X main.BuildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ') -X main.CommitHash=$(git rev-parse --short HEAD)" \
            -o bootstrap .

      - name: Create deployment artifact
        run: |
          mkdir -p deployment
          cp bootstrap deployment/bootstrap

      - name: Configure AWS credentials
        if: env.AWS_ROLE_TO_ASSUME != '' && env.AWS_OIDC_AUDIENCE != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
          audience: ${{ secrets.AWS_OIDC_AUDIENCE }}

      - name: Deploy to AWS Lambda
        if: env.AWS_ROLE_TO_ASSUME != '' && env.AWS_OIDC_AUDIENCE != ''
        uses: aws-actions/aws-lambda-deploy@v1
        with:
          function-name: pasteit
          code-artifacts-dir: deployment
          architectures: arm64
          runtime: provided.al2023
          handler: bootstrap
          publish: true
          role: ${{ secrets.LAMBDA_EXECUTION_ROLE }}
          s3-bucket: "${{ vars.BUCKET }}"
          environment: '{"S3_BUCKET":"${{ vars.S3_BUCKET }}","S3_PREFIX":"${{ vars.S3_PREFIX }}","URL":"${{ secrets.URL }}"}'

      - name: Create release artifact
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p releases
          zip -r releases/note-app-${{ github.ref_name }}-lambda.zip bootstrap

      - name: Upload release artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
